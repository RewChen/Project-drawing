<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</title>
  <link rel="icon" type="image/png" href="/img/logo.png" />
  <link rel="stylesheet" href="/css/manage.css" />
  <style>
    body { font-family: "Noto Sans Thai", sans-serif; color:#fff; margin:0; }
    .navbar { background:#fff; color:#111; display:flex; align-items:center; justify-content:space-between; padding:10px 30px; }
    .navbar .logo { width:80px; }
    .navbar ul { list-style:none; display:flex; gap:24px; margin:0; padding:0; }
    .navbar a { text-decoration:none; color:#111; font-weight:600; }

    .hero { position:relative; min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:60px 16px; }
    .hero::before{
      content:""; position:absolute; inset:0; background:url("/img/band.jpg") center/cover no-repeat;
      filter:brightness(.4); z-index:0;
    }

    .card {
      position:relative; z-index:1; width:min(720px, 92vw);
      background:rgba(0,0,0,.6); border-radius:16px; padding:24px 24px 28px;
      box-shadow:0 6px 24px rgba(0,0,0,.35);
    }

    .title { margin:0 0 8px; }
    .subtitle { margin:0 0 18px; opacity:.9; }

    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 260px; }

    label { display:block; margin:8px 0 6px; font-weight:600; }
    input, select {
      width:100%; padding:12px; border-radius:10px; border:none; font-size:16px; color:#111;
    }

    .pill {
      display:inline-block; background:#124d2d; color:#fff; padding:6px 14px; border-radius:999px; font-size:14px; margin-left:8px;
    }

    .actions { margin-top:18px; display:flex; gap:12px; justify-content:flex-end; }
    .btn {
      border:0; border-radius:999px; padding:10px 24px; font-size:16px; cursor:pointer;
    }
    .btn-primary { background:#124d2d; color:#fff; }
    .btn-primary:hover { filter:brightness(1.1); }
    .btn-ghost { background:transparent; color:#fff; outline:2px solid #fff; }
    .error { margin-top:10px; color:#ffd3d3; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <img src="/img/logo.png" alt="logo" class="logo" />
    <ul>
      <li><a href="/login.html">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></li>
      <li><a href="/main.html">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
      <li><a href="/notifications.html">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a></li>
      <li><a href="#">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a></li>
    </ul>
  </div>

  <div class="hero">
    <div class="card">
      <h2 class="title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h2>
      <p class="subtitle">
        ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        <span id="displayTable" class="pill"></span>
        <span id="displayDate" class="pill" style="background:#971212"></span>
      </p>

      <form id="reserveForm" novalidate>
        <div class="row">
          <div class="col">
            <label for="name">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
            <input type="text" id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô" required />
          </div>
          <div class="col">
            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" pattern="^0[0-9]{8,9}$" required />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input type="email" id="email" placeholder="‡πÄ‡∏ä‡πà‡∏ô name@example.com" />
          </div>
          <div class="col">
            <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
            <input type="date" id="date" required />
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-ghost" id="backBtn">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          <button type="submit" class="btn btn-primary" id="confirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á</button>
        </div>
        <div id="errorMsg" class="error" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage
    const table = localStorage.getItem("selectedTable") || "";
    const storedDate = localStorage.getItem("reservationDate") || "";

    if (!table) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô");
      location.href = "/reserve.html";
    }

    const displayTable = document.getElementById("displayTable");
    const displayDate  = document.getElementById("displayDate");
    const dateInput    = document.getElementById("date");

    displayTable.textContent = table ? `‡πÇ‡∏ï‡πä‡∏∞ ${table}` : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞";

    if (storedDate) {
      displayDate.textContent = storedDate;
      dateInput.value = storedDate;
    } else {
      const t = new Date();
      const pad = n => String(n).padStart(2, "0");
      const iso = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
      dateInput.value = iso;
      displayDate.textContent = iso;
    }

    document.getElementById("backBtn").addEventListener("click", () => history.back());

    const form = document.getElementById("reserveForm");
    const err  = document.getElementById("errorMsg");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      err.textContent = "";

      const name  = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const date  = document.getElementById("date").value;

      if (!name || !phone || !date) {
        err.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
        return;
      }

      const phonePattern = /^0[0-9]{8,9}$/;
      if (!phonePattern.test(phone)) {
        err.textContent = "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0812345678)";
        return;
      }

      try {
        const res = await fetch("/api/reservations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            table,
            name,
            phone,
            email,
            date
          })
        });

        if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");

        const data = await res.json();
        const newId = data?.newItem?.id;

        if (newId) {
          localStorage.setItem("lastReservationId", newId);
          alert("‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          // üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ reservation-info.html
          window.location.href = `/reservation-info.html?id=${newId}`;
        } else {
          throw new Error("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ID ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö");
        }

      } catch (e) {
        console.error(e);
        err.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
      }
    });
  </script>
</body>
</html>
